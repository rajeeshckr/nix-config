# NixOS Configuration Documentation

Comprehensive documentation for this repository. It covers flake inputs/outputs, system and user modules, services, networking, secrets, and workflows.

Repository: git@github.com:rajeeshckr/nix-config

---

## Quick Start

- Prerequisites: NixOS 24.11 (or compatible), flakes enabled (this repo enables flakes globally), internet access.
- Clone this repo into your NixOS host.
- Ensure secrets are set up (see Secrets Management).
- Switch to this configuration:
  - For the host named "nixos" provided by this flake:
    - nixos-rebuild switch --flake .#nixos
  - Handy alias available after first deploy:
    - update  (alias for sudo nixos-rebuild switch --flake .#nixos)

Formatting:
- nix fmt uses alejandra (provided via flake formatter).

---

## Flake Overview

File: flake.nix

Inputs:
- nixpkgs: github:nixos/nixpkgs/nixos-24.11 (stable)
- nixpkgs-unstable: github:nixos/nixpkgs/nixos-unstable (exposed as pkgs.unstable via overlay)
- home-manager: github:nix-community/home-manager/release-24.11
- agenix: github:ryantm/agenix (for age-encrypted secrets)
- nixos-hardware: github:NixOS/nixos-hardware/master

Outputs:
- packages: Import from ./pkgs (empty placeholder by default).
- formatter: alejandra per system (nix fmt).
- overlays:
  - additions: exposes ./pkgs into the package set
  - modifications: overlay stub for customizations
  - unstable-packages: exposes pkgs.unstable from nixpkgs-unstable
- nixosModules: exportable NixOS modules at ./modules/nixos (currently empty scaffold)
- homeManagerModules: exportable HM modules at ./modules/home-manager (currently empty scaffold)
- nixosConfigurations:
  - nixos: main host composed of:
    - ./nixos/configuration.nix (base)
    - ./nixos/desktop/configuration.nix (desktop/services)

Supported systems (for packages/formatter): aarch64/x86_64, linux and darwin.

---

## System Configuration

Files:
- nixos/configuration.nix (base)
- nixos/desktop/configuration.nix (desktop host config)
- nixos/desktop/hardware-configuration.nix (generated by nixos-generate-config; not documented here)

Base (nixos/configuration.nix):
- Imports: agenix.nixosModules.default
- nixpkgs config:
  - overlays: additions, modifications, unstable-packages
  - allowUnfree = true
- nix settings:
  - experimental-features = "nix-command flakes"
  - flake-registry = "" (disable global registry)
  - channel.enable = false
  - registry/nixPath derived from flake inputs
- Timezone: Australia/Melbourne
- Locale: en_US.UTF-8
- System packages: agenix CLI (inputs.agenix.packages.x86_64-linux.default)
- Firmware: hardware.enableRedistributableFirmware = true
- Secrets identity: age.identityPaths = [ "/root/.ssh/id_rsa" ]
- SSH: services.openssh.enable = true (keys-only is suggested)

Desktop host (nixos/desktop/configuration.nix):
- Imports:
  - ../config/graphical (XFCE definitions; see “Desktop environments” note)
  - ../config/common (zsh/oh-my-zsh, smartd, user module)
  - ../config/network (Tailscale, Nginx reverse proxy, DDNS example)
  - ../config/home-manager.nix (Home Manager integration)
  - ../config/llm.nix (Ollama service)
  - ./hardware-configuration.nix
  - ./transmission.nix
  - ./media.nix
  - ./samba.nix
- Bootloader: systemd-boot; boot.loader.efi.canTouchEfiVariables = true
- Kernel: boot.kernelPackages = pkgs.linuxPackages_latest
- Hostname: networking.hostName = "nixos"
- NetworkManager: enabled
- Programs: wireshark, nix-ld
- Filesystems:
  - fileSystems."/media" = { device = "/dev/sda2"; fsType = "auto"; options = [ "defaults" ]; }
- System packages (selected):
  - Editor/browser: vim, firefox-bin via HM (HM also sets firefox-bin), calibre
  - Social: mumble, element, gnupg
  - Dev/tools: wireshark, wine, winetricks, glances, nixfmt-rfc-style, mkcert, certbot, pciutils, usbutils
  - Gaming: pkgs.unstable.lutris, pkgs.unstable.shadps4, r2modman
  - Networking: ddclient, tailscale
  - Authentik package available (pkgs.authentik)
- Bluetooth: enabled with blueman and powerOnBoot
- Steam: enabled with firewall openings for Remote Play, dedicated server, LAN transfers
- Docker: enabled with rootless = true; setSocketVariable = true (Docker and Podman can coexist; HM sets podman for user)
- X11 / Display manager:
  - services.xserver.enable = true
  - GNOME: services.xserver.displayManager.gdm.enable = true; services.xserver.desktopManager.gnome.enable = true
- XKB: us layout
- Printing: CUPS enabled
- Audio: PipeWire with ALSA (32-bit) and Pulse; pulseaudio disabled
- User:
  - users.users.raj { isNormalUser = true; description = "raj"; extraGroups = [ "networkmanager" "wheel" ] }
  - Common module (see below) adds group “raj”, shell = zsh, extraGroups = [ wireshark wheel docker ]
- Unfree: nixpkgs.config.allowUnfree = true
- Prevent suspend/hibernate via polkit rules
- system.stateVersion = "24.11"

Desktop environments note:
- The graphical module (nixos/config/graphical/default.nix) enables XFCE and sets services.displayManager.defaultSession = "xfce".
- The desktop config enables GNOME and GDM.
- You should choose one DE and DM to avoid conflicts:
  - For GNOME only: do NOT import ../config/graphical or change it to disable XFCE.
  - For XFCE only: remove/disable GNOME/GDM lines in nixos/desktop/configuration.nix.

---

## Common System Module

File: nixos/config/common/default.nix
- Imports: ./users.nix
- Shell/zsh:
  - programs.zsh.enable = true
  - ohMyZsh.enable = true (theme: jonathan; plugins: git, thefuck)
  - shellAliases: ll, update
- SMART monitoring: services.smartd.enable = true

Users module: nixos/config/common/users.nix
- users.groups.raj = {}
- users.users.raj:
  - group = "raj"
  - shell = pkgs.zsh
  - extraGroups = [ "wireshark" "wheel" "docker" ]
  - isNormalUser = true

---

## Networking and Internet Exposure

File: nixos/config/network/internet-access.nix (imported via nixos/config/network/default.nix)
- Secrets:
  - age.secrets.ddclient-password.file = ../../../secrets/ddclient-password.age
- Tailscale:
  - services.tailscale.enable = true; openFirewall = true; useRoutingFeatures = "both"
- Cloudflared:
  - services.cloudflared.enable = true
- Dynamic DNS (ddclient):
  - services.ddclient.enable = false (disabled by default)
  - Configure domains/username/server/protocol; use passwordFile from age secret
- ACME/Let’s Encrypt:
  - security.acme.acceptTerms = true; defaults.email = "rajeesh.ckr@gmail.com"
- Nginx reverse proxy:
  - services.nginx.enable = true; recommendedProxySettings = true
  - Virtual host "rajeeshckr.ddnsgeek.com":
    - enableACME = true; forceSSL = true
    - Security headers incl. X-Content-Type-Options and a CSP
    - Location "/jellyfin/" proxies to http://127.0.0.1:8096/, with websockets and forward headers
- Firewall:
  - networking.firewall.enable = true
  - allowedTCPPorts = [ 22 80 443 8096 8000 ]  # SSH, HTTP, HTTPS, Jellyfin, vLLM
  - allowedUDPPorts = [ 41641 ]  # Tailscale

Additional setup notes:
- Port forwarding: forward 80/443/8096 from router to host if not using Tailscale Funnel
- Tailscale Funnel example (post-deploy):
  - sudo tailscale up
  - sudo tailscale serve https / http://localhost:8096

Reference: nixos/config/network/INTERNET-ACCESS-SETUP.md contains a full step-by-step.

---

## Media Stack

File: nixos/desktop/media.nix
- Packages:
  - pkgs.unstable.jellyfin, jellyfin-web, jellyfin-ffmpeg
- Jellyfin service:
  - services.jellyfin.enable = true; openFirewall = true
  - dataDir = /srv/data/jellyfin; cacheDir = /var/cache/jellyfin
- Radarr:
  - services.radarr.enable = true; dataDir = /srv/data/radarr; openFirewall = true
  - users.users.radarr.extraGroups = ["transmission"]
- Sonarr:
  - services.sonarr.enable = true; dataDir = /srv/data/sonarr; openFirewall = true
  - users.users.sonarr.extraGroups = ["transmission"]
- Jackett:
  - services.jackett.enable = true; dataDir = /srv/data/jackett; package = pkgs.unstable.jackett; openFirewall = true
- Bazarr:
  - services.bazarr.enable = true; openFirewall = true
  - users.users.bazarr.extraGroups = ["sonarr" "radarr"]
- Firewall:
  - UDP: [1900 7359 9091 9117 7878]  (includes DLNA; Transmission; Jackett; Radarr/Sonarr)
  - TCP: [8191]  (flaresolverr example)
- Optional OCI containers (commented): rarbg-selfhosted, flaresolverr

Directories to create (example):
- sudo mkdir -p /srv/data/{jellyfin,radarr,sonarr,jackett,bazarr}
- sudo chown -R jellyfin:jellyfin /srv/data/jellyfin (and similarly for other services per service user)

---

## Transmission

File: nixos/desktop/transmission.nix
- services.transmission:
  - enable = true; openFirewall = true
  - settings:
    - home = /srv/data/transmission
    - download-dir = /media/downloads
    - incomplete-dir = /media/transmission/.incomplete
    - rpc-bind-address = "0.0.0.0"; rpc-port = 9091
    - rpc-whitelist = "127.0.0.1,192.168.1.*"
    - rpc-host-whitelist-enabled = false
    - rpc-authentication-required = false
    - ratio-limit = "0.0"; ratio-limit-enabled = true
- Mitigate UI auth rate-limiting via periodic restart:
  - systemd timer: transmission-restart (runs hourly)
  - systemd oneshot service: restarts transmission.service

Security note:
- RPC is accessible on LAN; consider enabling authentication and/or firewall segmentation as needed.

---

## File Sharing (Samba)

File: nixos/desktop/samba.nix
- Samba:
  - services.samba.enable = true; openFirewall = true
  - Global config includes workgroup, security = user, guest account mapping, hosts allow/deny
  - Share "public":
    - path = /srv/data/radarr
    - browseable = yes; read only = no; guest ok = yes
- WSDD: services.samba-wsdd.enable = true; openFirewall = true
- Mount external SMB share:
  - fileSystems."/movies-indian":
    - device = //192.168.1.1/USB_Storage
    - fsType = cifs
    - options include guest, uid=1000, gid=986, iocharset=utf8, nofail, _netdev, x-systemd.automount
  - Ensure cifs-utils present (environment.systemPackages += [ cifs-utils ])
- Adjust uid/gid to match your user:
  - Use id -u raj and id -g raj to confirm (update fstab entry if needed).

---

## LLM Services

Ollama (nixos/config/llm.nix):
- services.ollama:
  - enable = true
  - package = pkgs.unstable.ollama-cuda
  - port = 11434; host = "0.0.0.0"; acceleration = "cuda"; openFirewall = true
  - loadModels = [ "deepseek-r1:14b" "gemma3:12b" ]
- Access on LAN: http://HOST:11434
- First start will download models; ensure GPU drivers are configured (see NVIDIA).

vLLM container (nixos/desktop/vllm.nix):
- hardware.nvidia-container-toolkit.enable = true
- age.secrets.hugging-face-ro-token.file = ../../secrets/hugging-face-ro-token.age
- virtualisation.oci-containers.containers.vllm:
  - autoStart = false (start manually as needed)
  - environmentFiles = [ config.age.secrets.hugging-face-ro-token.path ]
  - environment = { PYTORCH_CUDA_ALLOC_CONF = "expandable_segments:True"; }
  - extraOptions = [ "--ipc=host" "--device=nvidia.com/gpu=all" ]
  - cmd = [ "--model", "google/gemma-3-12b-pt", "--max-model-len", "4096", "--gpu-memory-utilization=0.85", "--dtype=float16" ]
  - image = vllm/vllm-openai:latest
  - ports = [ "8000:8000" ]
- Manage container service (Podman):
  - sudo systemctl start podman-vllm.service
  - sudo systemctl enable podman-vllm.service

---

## Desktop Environments and Graphical Stack

- XFCE module (nixos/config/graphical/default.nix):
  - services.xserver.enable = true
  - xfce.enable = true; xterm disabled; xkb layout "us"
  - services.displayManager.defaultSession = "xfce"
- GNOME (enabled in nixos/desktop/configuration.nix):
  - services.xserver.displayManager.gdm.enable = true
  - services.xserver.desktopManager.gnome.enable = true
- Choose one DE to avoid ambiguity (see note above).

---

## Home Manager

Integration module: nixos/config/home-manager.nix
- Imports Home Manager NixOS module: inputs.home-manager.nixosModules.home-manager
- HM users:
  - raj = import ../../home-manager/linux.nix
- extraSpecialArgs = { inputs, outputs } passed into HM modules

User config: home-manager/linux.nix
- Overlays: additions, modifications, unstable-packages
- allowUnfree = true
- systemd.user.startServices = "sd-switch"
- home.stateVersion = "24.11"
- Imports: ./common.nix

User common module: home-manager/common.nix
- Imports:
  - ./config/firefox.nix (firefox-bin)
  - ./config/vscode.nix (extensions set)
  - ./config/vim.nix (Neovim config)
  - ./config/kubernetes.nix (k9s plugins)
- direnv with nix-direnv enabled; zsh and bash integration
- home:
  - username = "raj"; homeDirectory = "/home/raj"
- fzf with zsh integration
- Symlink Docker CLI to Podman:
  - home.file:
    - Docker.source = ${pkgs.podman}/bin/podman
    - Docker.target = ~/.local/bin/docker
- PATH additions: ~/.local/bin, ~/go/bin
- EDITOR = "vim"
- Home packages (selected):
  - Kubernetes: kubectl, kubectx, kustomize, kubectl-explore, kubecolor, stern, kind
  - Dev/CLI: jq, git, gh, yq-go, ripgrep, direnv, sops, shellcheck, go-jsonnet, fzf, hyperfine, fd, bat, nil (Nix LSP), rust-analyzer, uv
  - Languages: unstable.go
  - Containers: podman, qemu
- Programs:
  - git with LFS enabled, useful aliases, global ignores, URL rewrite to SSH
  - home-manager.enable = true

Firefox HM module: home-manager/config/firefox.nix
- programs.firefox.enable = true
- package = pkgs.firefox-bin

VSCode HM module: home-manager/config/vscode.nix
- programs.vscode.enable = true
- Extensions (selected): Dracula theme, Vim, Go, Rust Analyzer, Ruby LSP, Nix IDE, HCL, ShellCheck, Systemd units, OpenSCAD, SOPS, Remote SSH, GitHub Copilot + Chat, Makefile tools

Neovim HM module: home-manager/config/vim.nix
- programs.neovim.enable = true; viAlias/vimAlias = true
- Basic indentation settings (4 spaces)
- Plugins: leap-nvim, vim-nix, vim-go, vim-ruby, vim-startify

Kubernetes HM module: home-manager/config/kubernetes.nix
- programs.k9s.enable = true
- Adds multiple k9s plugins for node operations, pausing/resuming reconciliation, live kubelet config, etc.
- Some plugins rely on kitty terminal and Kubernetes RBAC group "system:masters" via --as/--as-group flags

---

## GPU / NVIDIA

Optional file: nixos/config/nvidia.nix (currently not imported)
- nvidia.acceptLicense = true
- Xorg/Wayland videoDrivers = [ "modesetting" "nvidia" ]
- hardware.nvidia:
  - modesetting/powerManagement toggles
  - open driver = true
  - nvidiaSettings = true
  - package = config.boot.kernelPackages.nvidiaPackages.stable
- Optionally pin a specific NVIDIA driver with mkDriver (commented)
- PRIME/offload example commented

To use:
- Import ../config/nvidia.nix in nixos/desktop/configuration.nix
- Ensure the appropriate bus IDs and hardware settings are correct

---

## Secrets Management (agenix)

Files:
- secrets/secrets.nix: maps secret files to SSH public keys (age recipients)
  - Currently contains one recipient (root SSH RSA public key)
  - Files managed:
    - ddclient-password.age
    - hugging-face-ro-token.age
- NixOS base config:
  - age.identityPaths = [ "/root/.ssh/id_rsa" ]  # identity used to decrypt
- Example workflow:
  1) Ensure the SSH private key at /root/.ssh/id_rsa corresponds to the public key in secrets/secrets.nix.
  2) Create/edit secrets:
     - agenix -e secrets/ddclient-password.age
     - agenix -e secrets/hugging-face-ro-token.age
  3) Contents:
     - ddclient-password.age: plain text password/token for your DDNS provider
     - hugging-face-ro-token.age: an environment file used by vLLM container, e.g.:
       HUGGING_FACE_HUB_TOKEN=hf_XXXXXXXXXXXXXXXXXXXXXXXXXXXX
  4) Rebuild: sudo nixos-rebuild switch --flake .#nixos

Reference: https://github.com/ryantm/agenix

---

## Overlays and Custom Packages

- overlays/default.nix:
  - additions: import ../pkgs final.pkgs
  - modifications: placeholder for overriding packages
  - unstable-packages: imports nixpkgs-unstable with allowUnfree = true and exposes as pkgs.unstable
- pkgs/default.nix: custom packages placeholder
  - Define packages with pkgs.callPackage ./your-pkg { } and they become available as pkgs.your-pkg and via the additions overlay

---

## Filesystems and Paths

- /media mapped to /dev/sda2 (ensure device exists; adjust if needed)
- Create data directories for services (example):
  - sudo mkdir -p /srv/data/{transmission,jellyfin,radarr,sonarr,jackett,bazarr}
  - sudo mkdir -p /media/downloads /media/transmission/.incomplete
  - chown/chgrp accordingly (some service modules create their users; adjust ownership if required)

---

## Useful Commands

- Rebuild system:
  - sudo nixos-rebuild switch --flake .#nixos
- Format Nix files:
  - nix fmt
- Tail service logs:
  - journalctl -u nginx -f
  - journalctl -u jellyfin -f
  - journalctl -u transmission -f
  - journalctl -u tailscaled -f
  - journalctl -u podman-vllm -f
- Check open ports:
  - sudo ss -tulpn
- Tailscale:
  - sudo tailscale up
  - sudo tailscale status

---

## Security Considerations

- Only expose needed services; prefer Tailscale or Cloudflare Tunnel for remote access.
- If using direct exposure, secure Nginx with auth and strict CSP.
- Transmission RPC on LAN without auth: consider enabling auth and restricting whitelist.
- Keep secrets in agenix; never commit plaintext tokens/passwords.
- Regularly update: update

---

## Project Structure Summary

- flake.nix: flake inputs/outputs and nixosConfigurations
- overlays/: Nix overlays (unstable, custom packages)
- pkgs/: custom packages scaffold
- modules/nixos/: reusable NixOS modules (exported)
- modules/home-manager/: reusable HM modules (exported)
- nixos/configuration.nix: base NixOS config
- nixos/desktop/: desktop host config and services (transmission, media, samba, vllm)
- nixos/config/common/: shared system settings (users, zsh, smartd)
- nixos/config/network/: internet exposure (tailscale, cloudflared, nginx, ddclient)
- nixos/config/llm.nix: Ollama CUDA service
- nixos/config/nvidia.nix: optional NVIDIA config (not imported by default)
- home-manager/linux.nix: user HM entry (imports common.nix)
- home-manager/common.nix: HM programs, packages and configs
- home-manager/config/*.nix: app-specific HM modules (firefox, vscode, vim, kubernetes)
- secrets/: age-encrypted secret files and recipients mapping
- doc/FILES.md: brief file inventory
- doc/README.md: this documentation

---

## Known Choices to Review

- Desktop environment conflict (XFCE module vs GNOME in desktop config). Choose one.
- DDNS disabled by default; enable/configure if you require direct DNS exposure.
- Data directories and ownership for media stack; adjust to your storage layout.
- /media device and mount: adapt device path and filesystem type to your hardware.
- NVIDIA: import/configure only if running an NVIDIA GPU and you need it.
- vLLM autoStart is disabled; start when needed or set autoStart = true if desired.
